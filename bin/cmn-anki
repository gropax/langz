import sys
from pypinyin import pinyin
import jieba
from argparse import ArgumentParser, FileType


parser = ArgumentParser(description="Query YellowBridge online dictionary")
parser.add_argument('infile', nargs='?', type=FileType('r'), default=sys.stdin)
parser.add_argument('-o', '--outfile', type=FileType('w'), default=sys.stdout)
parser.add_argument('-f', '--format', type=str, default="stpdea")

parser.add_argument('--no-pinyin', action='store_false', dest="pinyin",
                    help="do not generate pinyin when missing")
parser.add_argument('--no-audio', action='store_false', dest="audio",
                    help="do not add the audio field")

args = parser.parse_args()


# Do not print logging to stderr
jieba.setLogLevel(60)


ANKI_FIELDS = ['simplified', 'traditional', 'pinyin', 'definition', 'example', 'audio']

FIELD_CODE = {
    's': 'simplified',
    't': 'traditional',
    'p': 'pinyin',
    'd': 'definition',
    'e': 'example',
    'a': 'audio',
    'q': 'quantifier',
    'c': 'category',
    'j': 'jyutping',
}

class AnkiCard:
    @staticmethod
    def format_field(field):
        f = field
        if '"' in f:
            f = f.replace('"', '&quot;')
        if "\t" in f or "\n" in f:
            f = '"' + f + '"'
        return f

    def __init__(self, fields):
        self.fields = fields

    def format(self):
        return "\t".join(self.format_field(f) for f in self.fields)


flen = len(args.format)

for l in args.infile:
    out = ""

    w = l.strip()
    if w:
        fields = w.split('\t')
        if len(fields) < flen:
            fields += [""] * (flen - len(fields))

        data = {}
        for i, c in enumerate(args.format):
            data[FIELD_CODE[c]] = fields[i]

        if args.pinyin:
            simp = data['simplified']
            cut = " ".join(jieba.cut(simp))
            data.setdefault('pinyin', "".join(l[0] for l in pinyin(cut)))

        if args.audio:
            data.setdefault('audio', "[sound:%s.mp3]" % data['simplified'])

        card_fields = [data.get(k, "") for k in ANKI_FIELDS]
        out = AnkiCard(card_fields).format()

    args.outfile.write("%s\n" % out)

# vim: set filetype=python:
